<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Student Timeline Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
  
  * { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
  
  body { 
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    min-height: 100vh;
    color: #1e293b;
  }
  
  .glass-panel {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(226, 232, 240, 0.8);
    border-radius: 16px;
    box-shadow: 0 4px 24px rgba(15, 23, 42, 0.08);
  }
  
  .left-sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    width: 280px;
    background: white;
    border-right: 2px solid #e2e8f0;
    overflow-y: auto;
    z-index: 40;
    box-shadow: 4px 0 24px rgba(15, 23, 42, 0.08);
  }
  
  .main-content {
    margin-left: 280px;
    padding: 24px;
  }
  
  .student-item {
    padding: 12px 16px;
    margin: 4px 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .student-item:hover {
    background: #f1f5f9;
  }
  
  .student-item.active {
    background: linear-gradient(135deg, #eef2ff, #e0e7ff);
    border-color: #6366f1;
  }
  
  .date-col {
    font-size: 11px;
    text-align: center;
    padding: 8px 4px;
    border-right: 1px solid rgba(226, 232, 240, 0.6);
    transition: all 0.2s;
    background: #fafafa;
  }
  
  .date-col:hover {
    background: rgba(99, 102, 241, 0.05);
  }
  
  .date-col.today {
    background: rgba(99, 102, 241, 0.1);
    border-color: rgba(99, 102, 241, 0.4);
    font-weight: 600;
  }
  
  .subject-row {
    border-bottom: 1px solid rgba(226, 232, 240, 0.6);
    transition: all 0.2s;
  }
  
  .subject-row:hover {
    background: rgba(99, 102, 241, 0.02);
  }
  
  .task-bar {
    position: absolute;
    height: 32px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    padding: 0 12px;
    font-size: 11px;
    font-weight: 600;
    color: white;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  
  .task-bar:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
    z-index: 10;
  }
  
  .task-bar-content {
    position: relative;
    z-index: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .progress-overlay {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.25);
    transition: width 0.3s;
    border-radius: 8px 0 0 8px;
  }
  
  .modal-backdrop { 
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 50;
    animation: fadeIn 0.2s;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .modal-content {
    background: white;
    border-radius: 20px;
    padding: 32px;
    width: 600px;
    max-width: 90vw;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(226, 232, 240, 0.8);
    animation: slideUp 0.3s;
  }
  
  @keyframes slideUp {
    from { 
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .side-panel {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    width: 600px;
    background: white;
    box-shadow: -4px 0 40px rgba(0, 0, 0, 0.15);
    z-index: 100;
    transform: translateX(100%);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow-y: auto;
    border-left: 1px solid rgba(226, 232, 240, 0.8);
  }
  
  .side-panel.open {
    transform: translateX(0);
  }
  
  .side-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(4px);
    z-index: 99;
    display: none;
  }
  
  .side-overlay.open {
    display: block;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
  }
  
  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
  }
  
  .btn-secondary {
    background: #f1f5f9;
    color: #334155;
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.2s;
    border: 1px solid #e2e8f0;
    cursor: pointer;
  }
  
  .btn-secondary:hover {
    background: #e2e8f0;
  }
  
  .btn-small {
    padding: 6px 12px;
    font-size: 12px;
  }
  
  .input-field {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 10px 14px;
    color: #1e293b;
    transition: all 0.2s;
  }
  
  .input-field:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }
  
  .stat-card {
    background: linear-gradient(135deg, #f8fafc, #ffffff);
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 16px;
    transition: all 0.2s;
  }
  
  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
  }
  
  input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 8px;
    border-radius: 5px;
    background: #e2e8f0;
    outline: none;
  }
  
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
    transition: all 0.2s;
  }
  
  .input-field:focus::range::-webkit-slider-thumb:hover {
    transform: scale(1.2);
  }
  
  .subject-label {
    font-weight: 600;
    font-size: 14px;
    padding: 12px 16px;
    background: linear-gradient(135deg, #f8fafc, #ffffff);
    border-right: 1px solid rgba(226, 232, 240, 0.6);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .nav-arrow {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border: 1px solid #e2e8f0;
    cursor: pointer;
    transition: all 0.2s;
    color: #64748b;
    font-weight: bold;
  }
  
  .nav-arrow:hover {
    background: #6366f1;
    color: white;
    border-color: #6366f1;
    transform: scale(1.05);
  }
  
  .uid-mapping {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .uid-code {
    font-family: 'Courier New', monospace;
    background: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    color: #6366f1;
    border: 1px solid #e0e7ff;
  }
  
  .note-entry {
    background: #f8fafc;
    border-left: 3px solid #6366f1;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 12px;
  }
  
  .note-timestamp {
    font-size: 11px;
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }
  
  .note-progress-badge {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 10px;
  }
</style>
</head>
<body>
  <!-- Left Sidebar -->
  <div class="left-sidebar">
    <div class="p-4 border-b-2 border-slate-200">
      <h2 class="text-lg font-bold text-slate-800 mb-3">üë• Students</h2>
      <button id="addStudentBtn" class="btn-primary w-full btn-small">+ Add Student</button>
    </div>
    <div id="studentsList" class="py-2"></div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <header class="glass-panel p-6 mb-6">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h1 class="text-4xl font-bold bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 bg-clip-text text-transparent">
            üìö <span id="currentStudentName">Student</span> Timeline
          </h1>
          <div class="text-sm text-slate-600 mt-1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Edsby Student Progress tracking</div>
        </div>
        
        <div class="flex items-center gap-3 flex-wrap">
          <div class="stat-card">
            <div class="text-xs text-slate-500 mb-1">Grade</div>
            <div id="studentGrade" class="text-lg font-bold text-slate-800">-</div>
          </div>
          
          <div class="stat-card">
            <div class="text-xs text-slate-500 mb-2">Overall Progress</div>
            <div class="flex items-center gap-3">
              <div class="w-32 h-2 bg-slate-200 rounded-full overflow-hidden">
                <div id="overallBar" style="height:100%; width:0%; transition:width 0.5s;"></div>
              </div>
              <div id="overallPct" class="text-lg font-bold text-slate-800">0%</div>
            </div>
          </div>
          
          <div class="flex items-center gap-2">
            <button class="nav-arrow" onclick="navigateDate(-1)">‚Üê</button>
            <select id="viewSelect" class="input-field text-sm font-medium">
              <option value="week">7 Days</option>
              <option value="month" selected>30 Days</option>
              <option value="quarter">90 Days</option>
            </select>
            <button class="nav-arrow" onclick="navigateDate(1)">‚Üí</button>
          </div>
          
          <button id="rulesBtn" class="btn-primary text-sm">
            ‚öôÔ∏è Class Mapping
          </button>
        </div>
      </div>
    </header>

    <section class="glass-panel p-6 mb-6">
      <div class="flex items-center gap-3 flex-wrap mb-3">
        <input id="studentGradeInput" class="input-field text-sm w-32" placeholder="Grade" />
        <button id="updateGradeBtn" class="btn-primary text-sm btn-small">
          ‚úì Update Grade
        </button>
      </div>
      <div class="flex items-center gap-3 flex-wrap">
        <input id="feedUrl" class="input-field flex-1 min-w-[300px] text-sm" placeholder="Paste .ics URL or leave blank to paste content below" />
        <button id="loadBtn" class="btn-primary text-sm">
          üì• Load Data
        </button>
        <button id="clearBtn" class="btn-secondary text-sm" style="background: #fee2e2; color: #991b1b; border-color: #fecaca;">
          üóëÔ∏è Clear Assignments
        </button>
      </div>
      <textarea id="icsArea" class="input-field w-full mt-3 text-sm font-mono" placeholder="Paste ICS content here if URL fetch fails..." style="height:80px"></textarea>
    </section>

    <section id="calendarArea" class="glass-panel overflow-hidden">
      <div id="dateHeader" class="grid border-b-2 border-slate-200"></div>
      <div id="subjectsWrap"></div>
    </section>
  </div>

  <!-- Assignment Modal -->
  <div id="modal" class="hidden">
    <div class="modal-backdrop" onclick="closeModal(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
        <h3 id="modalTitle" class="font-bold text-2xl mb-3 bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Assignment</h3>
        <div id="modalDesc" class="text-sm text-slate-600 mb-4 leading-relaxed whitespace-pre-line"></div>
        <div class="mb-4">
          <div class="text-xs font-semibold text-slate-700 mb-1">UID</div>
          <div id="modalUID" class="uid-code">N/A</div>
        </div>
        <div class="mb-6">
          <label class="text-xs font-semibold text-slate-700 block mb-3">Progress</label>
          <input id="modalSlider" type="range" min="0" max="100" class="w-full" />
          <div class="flex items-center justify-between text-sm mt-3">
            <div id="modalPct" class="text-xl font-bold text-indigo-600">0%</div>
            <label class="flex items-center gap-2 cursor-pointer text-slate-700 hover:text-slate-900 transition-colors">
              <input id="modalSubmitted" type="checkbox" class="rounded w-5 h-5" /> 
              <span>Turned in</span>
            </label>
          </div>
        </div>
        <div class="mb-6">
          <label class="text-xs font-semibold text-slate-700 block mb-2">Add Note</label>
          <textarea id="modalNoteInput" class="input-field w-full text-sm" style="height:80px" placeholder="Add a new note (will be saved with current progress %)..."></textarea>
          <button id="addNoteBtn" class="btn-primary btn-small mt-2">üí¨ Add Note</button>
        </div>
        <div class="mb-6">
          <label class="text-xs font-semibold text-slate-700 block mb-3">Notes History</label>
          <div id="notesHistory" class="max-h-64 overflow-y-auto"></div>
        </div>
        <div class="flex justify-end gap-3">
          <button class="btn-secondary" onclick="closeModal()">Close</button>
          <button class="btn-primary" onclick="saveModal()">Save Progress</button>
        </div>
      </div>
    </div>
  </div>

  <!-- UID Rules Side Panel -->
  <div id="sideOverlay" class="side-overlay" onclick="closeRulesPanel()"></div>
  <div id="sidePanel" class="side-panel">
    <div class="p-8">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">‚öôÔ∏è UID to Subject Mapping</h2>
        <button onclick="closeRulesPanel()" class="text-slate-400 hover:text-slate-700 text-3xl leading-none transition-colors">&times;</button>
      </div>
      <p class="text-sm text-slate-600 mb-6 leading-relaxed">
        Map UID patterns to subject names. The system extracts the numeric ID from UIDs (e.g., "353349532" from "353349532.362628486@rbe.edsby.com") and matches it against your rules.
      </p>
      
      <!-- Rules Editor - At Top -->
      <div class="mb-6 p-4 bg-red-50 border-2 border-red-300 rounded-lg">
        <div class="text-sm font-semibold text-red-800 mb-3">‚ö†Ô∏è Critical Settings - Handle with Care</div>
        <div class="mb-4">
          <label class="text-xs font-semibold text-slate-700 block mb-3">UID Mapping Rules (JSON format)</label>
          <textarea id="rulesEditor" class="input-field w-full text-sm font-mono" style="height:300px"></textarea>
        </div>
        <div class="flex gap-3">
          <button id="saveRulesBtn" class="btn-primary flex-1">‚úÖ Save Rules</button>
          <button id="resetRulesBtn" class="btn-secondary">üîÑ Reset to Default</button>
        </div>
      </div>
      
      <div class="mb-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-xs text-indigo-900 leading-relaxed">
        <strong>üí° Tip:</strong> Add the numeric UID prefix (before the dot) to categorize all events from that source. Example: "353349532" catches all events from that teacher/class.
      </div>
      
      <!-- Discovered UIDs - Below -->
      <div class="mb-6">
        <h3 class="text-sm font-semibold text-slate-700 mb-3">üìä Discovered UIDs (From Current Student)</h3>
        <div id="discoveredUIDs" class="max-h-64 overflow-y-auto space-y-2"></div>
      </div>
    </div>
  </div>

<script>
const storageKey = 'student_timeline_v5';
const rulesKey = 'uid_rules_v5';

let globalState = JSON.parse(localStorage.getItem(storageKey) || '{}');
if (!globalState.students) globalState.students = {};
if (!globalState.currentStudentId) globalState.currentStudentId = null;
if (!globalState.dateOffset) globalState.dateOffset = 0;

const defaultRules = {
  "353349532": "AP Chemistry",
  "353349207": "AP Biology",
  "353349408": "AP Calculus",
  "40019979": "Career/Guidance",
  "364412048": "Clubs & Activities",
  "263366546": "Clubs & Activities",
  "247096034": "Clubs & Activities",
  "167705440": "Music",
  "145977351": "Personal"
};

let rules = JSON.parse(localStorage.getItem(rulesKey) || 'null') || defaultRules;

function saveGlobalState(){ localStorage.setItem(storageKey, JSON.stringify(globalState)); }
function saveRules(){ localStorage.setItem(rulesKey, JSON.stringify(rules)); }

function getCurrentStudent() {
  if (!globalState.currentStudentId) return null;
  return globalState.students[globalState.currentStudentId];
}

function renderStudentsList() {
  const list = document.getElementById('studentsList');
  list.innerHTML = '';
  
  const studentIds = Object.keys(globalState.students);
  if (studentIds.length === 0) {
    list.innerHTML = '<div class="text-sm text-slate-500 p-4 text-center">No students yet</div>';
    return;
  }
  
  studentIds.forEach(id => {
    const student = globalState.students[id];
    const item = document.createElement('div');
    item.className = `student-item ${id === globalState.currentStudentId ? 'active' : ''}`;
    item.innerHTML = `
      <div>
        <div class="font-semibold text-slate-800">${student.name}</div>
        <div class="text-xs text-slate-500">Grade: ${student.grade || '-'}</div>
      </div>
      <button class="btn-secondary btn-small" onclick="deleteStudent('${id}', event)" style="padding: 4px 8px;">üóëÔ∏è</button>
    `;
    item.onclick = (e) => {
      if (e.target.tagName !== 'BUTTON') {
        selectStudent(id);
      }
    };
    list.appendChild(item);
  });
}

function selectStudent(id) {
  globalState.currentStudentId = id;
  globalState.dateOffset = 0;
  saveGlobalState();
  updateStudentDisplay();
  renderStudentsList();
  render();
}

function deleteStudent(id, event) {
  event.stopPropagation();
  const student = globalState.students[id];
  if (!confirm(`Delete ${student.name} and all their data?`)) return;
  delete globalState.students[id];
  if (globalState.currentStudentId === id) {
    const remaining = Object.keys(globalState.students);
    globalState.currentStudentId = remaining.length > 0 ? remaining[0] : null;
  }
  saveGlobalState();
  renderStudentsList();
  updateStudentDisplay();
  render();
}

document.getElementById('addStudentBtn').addEventListener('click', ()=> {
  const name = prompt('Enter student name:');
  if (!name || !name.trim()) return;
  const grade = prompt('Enter grade:') || '';
  const id = 'student_' + Date.now();
  globalState.students[id] = {
    name: name.trim(),
    grade: grade.trim(),
    assignments: [],
    icsData: ''
  };
  globalState.currentStudentId = id;
  saveGlobalState();
  renderStudentsList();
  updateStudentDisplay();
  render();
});

document.getElementById('updateGradeBtn').addEventListener('click', ()=> {
  const student = getCurrentStudent();
  if (!student) { alert('No student selected'); return; }
  const grade = document.getElementById('studentGradeInput').value.trim();
  if (grade) {
    student.grade = grade;
    saveGlobalState();
    updateStudentDisplay();
    renderStudentsList();
  }
});

function updateStudentDisplay(){
  const student = getCurrentStudent();
  if (!student) {
    document.getElementById('currentStudentName').textContent = 'No Student';
    document.getElementById('studentGrade').textContent = '-';
    document.getElementById('studentGradeInput').value = '';
    return;
  }
  document.getElementById('currentStudentName').textContent = student.name;
  document.getElementById('studentGrade').textContent = student.grade || '-';
  document.getElementById('studentGradeInput').value = student.grade || '';
}

function navigateDate(direction) {
  const view = document.getElementById('viewSelect').value;
  const days = view === 'week' ? 7 : (view === 'month' ? 30 : 90);
  globalState.dateOffset += (direction * days);
  saveGlobalState();
  render();
}

function extractUIDPrefix(uid) {
  if (!uid) return null;
  const match = uid.match(/^(\d+)/);
  return match ? match[1] : null;
}

function parseICS(ics) {
  const events = [];
  const lines = ics.split(/\r?\n/);
  let inEvent = false, inTodo = false, cur = {};
  
  for (const raw of lines) {
    let line = raw.trim();
    
    if (line.match(/^[\s\t]/) && Object.keys(cur).length > 0) {
      const lastKey = Object.keys(cur).pop();
      cur[lastKey] += line.trim();
      continue;
    }
    
    if (!line) continue;
    
    if (line === 'BEGIN:VEVENT') { inEvent = true; cur = {type:'event'}; continue; }
    if (line === 'BEGIN:VTODO') { inTodo = true; cur = {type:'todo'}; continue; }
    if (line === 'END:VEVENT') { 
      inEvent = false; 
      if (cur.SUMMARY && cur.UID) events.push(cur); 
      cur = {}; 
      continue; 
    }
    if (line === 'END:VTODO') { 
      inTodo = false; 
      if (cur.SUMMARY && cur.UID) events.push(cur); 
      cur = {}; 
      continue; 
    }
    
    if (!inEvent && !inTodo) continue;
    
    const idx = line.indexOf(':');
    if (idx<0) continue;
    const key = line.substring(0, idx).split(';')[0];
    const val = line.substring(idx+1);
    cur[key] = val;
  }
  
  return events.map(ev=>{
    const postedDate = ev.DTSTAMP ? parseICalDate(ev.DTSTAMP) : new Date();
    const startDate = ev.DTSTART ? parseICalDate(ev.DTSTART) : (ev.DUE ? parseICalDate(ev.DUE) : postedDate);
    const title = ev.SUMMARY || 'Assignment';
    const uid = ev.UID || '';
    const uidPrefix = extractUIDPrefix(uid);
    const subject = categorizeByUID(uidPrefix);
    const teacher = extractTeacher(ev.ORGANIZER || '');
    
    return { 
      id: uid || generateId(title + postedDate), 
      title, 
      subject, 
      teacher,
      uid,
      uidPrefix,
      postedISO: postedDate.toISOString(),
      dueISO: startDate.toISOString(), 
      desc: ev.DESCRIPTION || ''
    };
  });
}

function parseICalDate(s){
  if (!s) return new Date();
  if (/^\d{8}$/.test(s)) {
    const y=+s.slice(0,4), m=+s.slice(4,6)-1, d=+s.slice(6,8);
    return new Date(y,m,d);
  }
  const m = s.match(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})Z?/);
  if (m) return new Date(Date.UTC(+m[1],+m[2]-1,+m[3],+m[4],+m[5],+m[6]));
  return new Date(s);
}

function extractTeacher(org){
  if (!org) return 'School-Wide';
  const m = org.match(/CN=([^:;]+)/);
  return m ? m[1].trim() : 'School-Wide';
}

function categorizeByUID(uidPrefix){
  if (!uidPrefix) return 'General';
  return rules[uidPrefix] || 'General';
}

function generateId(s){ 
  return 'id_' + btoa(unescape(encodeURIComponent(s))).replace(/[^a-zA-Z0-9]/g,'').slice(0,16); 
}

function mergeEvents(parsed) {
  const student = getCurrentStudent();
  if (!student) return;
  
  for (const ev of parsed) {
    const existing = student.assignments.find(a=>a.id===ev.id);
    if (!existing) {
      student.assignments.push({...ev, progress:0, notesHistory:[], submitted:false});
    } else {
      Object.assign(existing, {...ev, progress: existing.progress, notesHistory: existing.notesHistory || [], submitted: existing.submitted});
    }
  }
  student.assignments.sort((a,b)=> new Date(a.postedISO) - new Date(b.postedISO));
  saveGlobalState();
}

function updateDiscoveredUIDs() {
  const student = getCurrentStudent();
  if (!student) return;
  
  const uidSet = new Set();
  for (const a of student.assignments) {
    if (a.uidPrefix) uidSet.add(a.uidPrefix);
  }
  
  const container = document.getElementById('discoveredUIDs');
  container.innerHTML = '';
  
  if (uidSet.size === 0) {
    container.innerHTML = '<div class="text-slate-500 text-sm">No UIDs discovered yet. Load data first.</div>';
    return;
  }
  
  Array.from(uidSet).sort().forEach(uid => {
    const mapping = document.createElement('div');
    mapping.className = 'uid-mapping';
    const subject = rules[uid] || 'General';
    const count = student.assignments.filter(a => a.uidPrefix === uid).length;
    mapping.innerHTML = `
      <div class="uid-code">${uid}</div>
      <div class="flex-1 text-sm">
        <div class="font-semibold text-slate-700">${subject}</div>
        <div class="text-xs text-slate-500">${count} items</div>
      </div>
    `;
    container.appendChild(mapping);
  });
}

document.getElementById('loadBtn').addEventListener('click', async ()=>{
  const student = getCurrentStudent();
  if (!student) { alert('Please select or add a student first'); return; }
  
  const txt = document.getElementById('icsArea').value.trim();
  if (txt) {
    student.icsData = txt;
    const parsed = parseICS(txt);
    mergeEvents(parsed);
    render();
    return;
  }
  const url = document.getElementById('feedUrl').value.trim();
  if (!url) { alert('Paste ICS content or provide URL'); return; }
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error('Fetch failed');
    const body = await res.text();
    student.icsData = body;
    const parsed = parseICS(body);
    mergeEvents(parsed);
    render();
  } catch(e){
    alert('Unable to fetch (CORS?). Paste .ics content in the text box instead.');
  }
});

document.getElementById('clearBtn').addEventListener('click', ()=> {
  const student = getCurrentStudent();
  if (!student) return;
  if (!confirm('Clear all assignments and progress for this student?')) return;
  student.assignments = [];
  student.icsData = '';
  saveGlobalState();
  render();
});

document.getElementById('viewSelect').addEventListener('change', ()=> {
  globalState.dateOffset = 0;
  saveGlobalState();
  render();
});

document.getElementById('rulesBtn').addEventListener('click', ()=> {
  document.getElementById('rulesEditor').value = JSON.stringify(rules, null, 2);
  updateDiscoveredUIDs();
  document.getElementById('sidePanel').classList.add('open');
  document.getElementById('sideOverlay').classList.add('open');
});

function closeRulesPanel(){
  document.getElementById('sidePanel').classList.remove('open');
  document.getElementById('sideOverlay').classList.remove('open');
}

document.getElementById('saveRulesBtn').addEventListener('click', ()=> {
  try {
    const newRules = JSON.parse(document.getElementById('rulesEditor').value);
    rules = newRules;
    saveRules();
    Object.values(globalState.students).forEach(student => {
      student.assignments.forEach(a => {
        a.subject = categorizeByUID(a.uidPrefix);
      });
    });
    saveGlobalState();
    render();
    closeRulesPanel();
    alert('‚úÖ Rules saved and applied!');
  } catch(e) {
    alert('‚ùå Invalid JSON format. Please check syntax.');
  }
});

document.getElementById('resetRulesBtn').addEventListener('click', ()=> {
  if (!confirm('Reset rules to default?')) return;
  rules = {...defaultRules};
  saveRules();
  document.getElementById('rulesEditor').value = JSON.stringify(rules, null, 2);
  Object.values(globalState.students).forEach(student => {
    student.assignments.forEach(a => {
      a.subject = categorizeByUID(a.uidPrefix);
    });
  });
  saveGlobalState();
  render();
  alert('‚úÖ Rules reset to defaults');
});

function render(){
  const student = getCurrentStudent();
  if (!student) {
    document.getElementById('subjectsWrap').innerHTML = '<div class="text-slate-500 p-12 text-center text-lg">üë§ Please select or add a student</div>';
    document.getElementById('overallBar').style.width = '0%';
    document.getElementById('overallPct').textContent = '0%';
    return;
  }
  
  const now = new Date();
  now.setHours(0, 0, 0, 0);
  const view = document.getElementById('viewSelect').value;
  const days = view === 'week' ? 7 : (view === 'month' ? 30 : 90);
  
  const start = new Date(now);
  start.setDate(start.getDate() + globalState.dateOffset);
  const end = new Date(start);
  end.setDate(start.getDate() + days - 1);

  // Render date header
  const dateHeader = document.getElementById('dateHeader');
  dateHeader.innerHTML = '';
  dateHeader.style.gridTemplateColumns = `200px repeat(${days}, minmax(0, 1fr))`;
  
  const cornerCell = document.createElement('div');
  cornerCell.className = 'date-col font-bold text-slate-700';
  cornerCell.style.gridColumn = '1';
  cornerCell.textContent = 'Subject';
  dateHeader.appendChild(cornerCell);
  
  const todayDate = new Date();
  todayDate.setHours(0, 0, 0, 0);
  
  for (let i=0; i<days; i++){
    const d = new Date(start);
    d.setDate(start.getDate() + i);
    const col = document.createElement('div');
    const isToday = d.getTime() === todayDate.getTime();
    col.className = `date-col ${isToday ? 'today' : ''}`;
    col.innerHTML = `
      <div class="text-xs ${isToday ? 'text-indigo-600 font-bold' : 'text-slate-500'}">
        ${d.toLocaleDateString(undefined,{weekday:'short'})}
      </div>
      <div class="text-base ${isToday ? 'text-indigo-700 font-bold' : 'text-slate-700'}">${d.getDate()}</div>
      <div class="text-xs ${isToday ? 'text-indigo-500' : 'text-slate-400'}">${d.toLocaleDateString(undefined,{month:'short'})}</div>
    `;
    dateHeader.appendChild(col);
  }

  // Group by subject
  const subjectGroups = {};
  for (const a of student.assignments) {
    const subj = a.subject || 'General';
    if (!subjectGroups[subj]) subjectGroups[subj] = [];
    subjectGroups[subj].push(a);
  }

  const subjectsWrap = document.getElementById('subjectsWrap');
  subjectsWrap.innerHTML = '';

  const subjects = Object.keys(subjectGroups).sort();
  if (subjects.length === 0) {
    subjectsWrap.innerHTML = '<div class="text-slate-500 p-12 text-center text-lg">üì≠ No assignments yet. Load ICS data.</div>';
    updateOverall();
    return;
  }

  for (const subj of subjects) {
    const arr = subjectGroups[subj];
    const row = document.createElement('div');
    row.className = 'subject-row';
    row.style.display = 'grid';
    row.style.gridTemplateColumns = `200px repeat(${days}, minmax(0, 1fr))`;
    
    // Subject label column
    const label = document.createElement('div');
    label.className = 'subject-label';
    const subjPct = subjectPercent(arr);
    const subjColor = colorForPercent(subjPct);
    label.innerHTML = `
      <div class="flex-1">
        <div class="text-slate-800">${subj}</div>
        <div class="text-xs text-slate-500">${arr.length} items ¬∑ ${Math.round(subjPct)}%</div>
      </div>
      <div class="w-16 h-2 rounded-full" style="background:${subjColor}"></div>
    `;
    row.appendChild(label);

    // Timeline cells
    const timelineContainer = document.createElement('div');
    timelineContainer.style.gridColumn = `2 / span ${days}`;
    timelineContainer.style.position = 'relative';
    timelineContainer.style.padding = '8px 0';
    
    // Create lanes for overlapping assignments
    const lanes = arrangeLanes(arr, start, end);
    const laneHeight = 40;
    timelineContainer.style.minHeight = (lanes.length * laneHeight + 16) + 'px';
    
    lanes.forEach((lane, laneIndex) => {
      lane.forEach(a => {
        const posted = new Date(a.postedISO);
        const due = new Date(a.dueISO);
        
        // Skip if due date has passed (before the start of the view window)
        if (due < start) return;
        
        // Fix invalid entries where posted > due (span only one day)
        let barStart, barEnd;
        if (posted > due) {
          // Error case: use due date for both start and end, span one day
          barStart = due;
          barEnd = new Date(due);
          barEnd.setDate(barEnd.getDate() + 1);
        } else {
          // Normal case: bar extends from posted to due
          barStart = posted;
          barEnd = due;
        }
        
        const startPos = dateToPercent(barStart, start, end);
        const endPos = dateToPercent(barEnd, start, end);
        const width = Math.max(endPos - startPos, 2);
        
        const bar = document.createElement('div');
        bar.className = 'task-bar';
        bar.style.left = startPos + '%';
        bar.style.width = width + '%';
        bar.style.top = (laneIndex * laneHeight + 8) + 'px';
        bar.style.background = getTaskColor(due, a.submitted);
        
        const progressOverlay = document.createElement('div');
        progressOverlay.className = 'progress-overlay';
        progressOverlay.style.width = (a.progress || 0) + '%';
        bar.appendChild(progressOverlay);
        
        const content = document.createElement('div');
        content.className = 'task-bar-content';
        content.textContent = a.title;
        bar.appendChild(content);
        
        const warningText = posted > due ? ' ‚ö†Ô∏è Invalid dates' : '';
        bar.title = `${a.title}\nPosted: ${posted.toLocaleDateString()}\nDue: ${due.toLocaleDateString()}\nProgress: ${a.progress}%\nTeacher: ${a.teacher}${warningText}`;
        bar.addEventListener('click', ()=> openModalFor(a.id));
        
        timelineContainer.appendChild(bar);
      });
    });
    
    row.appendChild(timelineContainer);
    subjectsWrap.appendChild(row);
  }

  updateOverall();
}

// Arrange assignments into non-overlapping lanes
function arrangeLanes(assignments, start, end) {
  const sorted = [...assignments].sort((a, b) => {
    const aPosted = new Date(a.postedISO);
    const bPosted = new Date(b.postedISO);
    return aPosted - bPosted;
  });
  
  const lanes = [];
  
  for (const assignment of sorted) {
    const posted = new Date(assignment.postedISO);
    const due = new Date(assignment.dueISO);
    
    // Find first lane where this assignment doesn't overlap
    let placed = false;
    for (const lane of lanes) {
      let overlaps = false;
      for (const existing of lane) {
        const existingPosted = new Date(existing.postedISO);
        const existingDue = new Date(existing.dueISO);
        
        // Check for overlap
        if (!(due < existingPosted || posted > existingDue)) {
          overlaps = true;
          break;
        }
      }
      
      if (!overlaps) {
        lane.push(assignment);
        placed = true;
        break;
      }
    }
    
    // Create new lane if needed
    if (!placed) {
      lanes.push([assignment]);
    }
  }
  
  return lanes;
}

function getTaskColor(dueDate, submitted) {
  if (submitted) return 'linear-gradient(135deg, #10b981, #059669)';
  
  const now = new Date();
  const diff = (dueDate - now) / (1000*60*60*24);
  
  if (diff < 0) return 'linear-gradient(135deg, #7f1d1d, #991b1b)';
  if (diff <= 1) return 'linear-gradient(135deg, #dc2626, #ef4444)';
  if (diff <= 3) return 'linear-gradient(135deg, #f59e0b, #fbbf24)';
  if (diff <= 7) return 'linear-gradient(135deg, #3b82f6, #60a5fa)';
  return 'linear-gradient(135deg, #6366f1, #8b5cf6)';
}

function dateToPercent(date, start, end){
  const s = start.getTime(), e = end.getTime(), t = date.getTime();
  let p = ((t - s) / (e - s)) * 100;
  return Math.max(0, Math.min(100, p));
}

function subjectPercent(arr){
  if (!arr || arr.length===0) return 0;
  return arr.reduce((s,a)=> s + (a.progress || 0), 0) / arr.length;
}

function colorForPercent(p){
  if (p >= 80) return 'linear-gradient(135deg, #10b981, #059669)';
  if (p >= 50) return 'linear-gradient(135deg, #f59e0b, #fb923c)';
  return 'linear-gradient(135deg, #ef4444, #dc2626)';
}

let currentModalId = null;

function renderNotesHistory(assignment) {
  const container = document.getElementById('notesHistory');
  if (!assignment.notesHistory || assignment.notesHistory.length === 0) {
    container.innerHTML = '<div class="text-slate-500 text-sm">No notes yet</div>';
    return;
  }
  
  container.innerHTML = '';
  assignment.notesHistory.slice().reverse().forEach(note => {
    const entry = document.createElement('div');
    entry.className = 'note-entry';
    const date = new Date(note.timestamp);
    entry.innerHTML = `
      <div class="note-timestamp">
        <span>${date.toLocaleDateString()} ${date.toLocaleTimeString()}</span>
        <span class="note-progress-badge">${note.progress}%</span>
      </div>
      <div class="text-sm text-slate-700">${note.text}</div>
    `;
    container.appendChild(entry);
  });
}

function openModalFor(id){
  const student = getCurrentStudent();
  if (!student) return;
  
  currentModalId = id;
  const a = student.assignments.find(x=>x.id===id);
  if (!a) return;
  
  document.getElementById('modalTitle').textContent = `${a.title}`;
  document.getElementById('modalDesc').textContent = `Subject: ${a.subject}\n${a.desc || 'No description'}\n\nPosted: ${new Date(a.postedISO).toLocaleDateString()}\nDue: ${new Date(a.dueISO).toLocaleDateString()}\nTeacher: ${a.teacher}`;
  document.getElementById('modalUID').textContent = a.uid || 'N/A';
  document.getElementById('modalSlider').value = a.progress || 0;
  document.getElementById('modalPct').textContent = (a.progress||0) + '%';
  document.getElementById('modalSubmitted').checked = !!a.submitted;
  document.getElementById('modalNoteInput').value = '';
  
  if (!a.notesHistory) a.notesHistory = [];
  renderNotesHistory(a);
  
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('modal').style.display = 'block';
  document.getElementById('modalSlider').oninput = function(){
    document.getElementById('modalPct').textContent = this.value + '%';
  };
}

document.getElementById('addNoteBtn').addEventListener('click', ()=> {
  const student = getCurrentStudent();
  if (!student || !currentModalId) return;
  
  const a = student.assignments.find(x=>x.id===currentModalId);
  if (!a) return;
  
  const noteText = document.getElementById('modalNoteInput').value.trim();
  if (!noteText) {
    alert('Please enter a note');
    return;
  }
  
  const progress = +document.getElementById('modalSlider').value;
  
  if (!a.notesHistory) a.notesHistory = [];
  a.notesHistory.push({
    timestamp: new Date().toISOString(),
    progress: progress,
    text: noteText
  });
  
  document.getElementById('modalNoteInput').value = '';
  saveGlobalState();
  renderNotesHistory(a);
  alert('‚úÖ Note added!');
});

function closeModal(e){
  document.getElementById('modal').classList.add('hidden');
  document.getElementById('modal').style.display = 'none';
  currentModalId = null;
}

function saveModal(){
  const student = getCurrentStudent();
  if (!student || !currentModalId) return;
  
  const a = student.assignments.find(x=>x.id===currentModalId);
  if (!a) return;
  a.progress = +document.getElementById('modalSlider').value;
  a.submitted = !!document.getElementById('modalSubmitted').checked;
  saveGlobalState();
  render();
  closeModal();
}

function updateOverall(){
  const student = getCurrentStudent();
  if (!student || student.assignments.length === 0) {
    document.getElementById('overallBar').style.width = '0%';
    document.getElementById('overallPct').textContent = '0%';
    return;
  }
  
  const arr = student.assignments;
  const overall = arr.length ? Math.round(arr.reduce((s,a)=> s + (a.progress || 0), 0) / arr.length) : 0;
  const bar = document.getElementById('overallBar');
  bar.style.width = overall + '%';
  bar.style.background = overall >= 80 ? 'linear-gradient(135deg, #10b981, #059669)' : 
                          overall >= 50 ? 'linear-gradient(135deg, #f59e0b, #fb923c)' : 
                          'linear-gradient(135deg, #ef4444, #dc2626)';
  document.getElementById('overallPct').textContent = overall + '%';
}

// Initialize
renderStudentsList();
updateStudentDisplay();
render();
</script>
</body>
</html> 